<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Feedback Admin â€” College</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: #f3f4f6;
      color: #111827;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 18px 18px 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .login-box {
      margin-top: 10px;
      padding: 14px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .login-title {
      font-size: 13px;
      margin-bottom: 8px;
      color: #111827;
    }

    .input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-size: 13px;
      margin-bottom: 8px;
      outline: none;
    }

    .input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #60a5fa, #2563eb);
      color: white;
      box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .error {
      font-size: 12px;
      color: #dc2626;
      margin-top: 4px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      color: #4b5563;
      background: #f3f4ff;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #e5e7eb;
    }

    .logout-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      color: #374151;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
    }

    .stats {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .stats span {
      margin-right: 12px;
    }

    .list {
      margin-top: 4px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      max-height: 60vh;
      overflow-y: auto;
    }

    .item {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-message {
      font-size: 14px;
      color: #111827;
      white-space: pre-wrap;
    }

    .item-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .item-meta {
      font-size: 11px;
      color: #6b7280;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid;
    }

    .status-new {
      border-color: rgba(239,68,68,0.3);
      background: #fef2f2;
      color: #b91c1c;
    }

    .status-resolved {
      border-color: rgba(34,197,94,0.3);
      background: #ecfdf3;
      color: #166534;
    }

    .status-toggle-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      color: #374151;
      white-space: nowrap;
    }

    .status-toggle-btn:hover {
      background: #e5e7eb;
    }

    @media (max-width: 600px) {
      .app { padding: 14px; }
      h1 { font-size: 18px; }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Feedback Admin</h1>
    <div class="subtitle">View and manage anonymous feedback submitted by students.</div>

    <!-- Not logged in -->
    <div id="loginSection" class="login-box">
      <div class="login-title">Admin Login</div>
      <input id="email" type="email" class="input" placeholder="Admin email" />
      <input id="password" type="password" class="input" placeholder="Password" />
      <button id="loginBtn" class="btn">Login</button>
      <div id="loginError" class="error"></div>
    </div>

    <!-- Logged in view -->
    <div id="adminSection" style="display:none;">
      <div class="top-bar">
        <div class="pill">
          Signed in as <span id="adminEmail"></span>
        </div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>

      <div id="statsBar" class="stats">
        <span>Total: 0</span>
        <span>New: 0</span>
        <span>Resolved: 0</span>
      </div>

      <div class="list" id="feedbackList">
        <!-- feedback items here -->
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

  <script>
    // SAME CONFIG AS FEEDBACK WEBSITE
    const firebaseConfig = {
      apiKey: "AIzaSyA0tHemLD6WOOjuKQ5cGfCe_VPvMQSgVVA",
      authDomain: "college-feedback-590e1.firebaseapp.com",
      projectId: "college-feedback-590e1",
      storageBucket: "college-feedback-590e1.firebasestorage.app",
      messagingSenderId: "511708349056",
      appId: "1:511708349056:web:db1518f6609ab623c45c65",
      measurementId: "G-9QJY1T6G6L"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
    const adminEmailEl = document.getElementById('adminEmail');
    const feedbackList = document.getElementById('feedbackList');
    const statsBar = document.getElementById('statsBar');

    let unsubscribe = null;

    function renderFeedback(snapshot) {
      feedbackList.innerHTML = '';

      let total = 0;
      let newCount = 0;
      let resolvedCount = 0;

      if (snapshot.empty) {
        feedbackList.innerHTML = '<div class="item"><div class="item-message">No feedback yet.</div></div>';
        statsBar.innerHTML = '<span>Total: 0</span><span>New: 0</span><span>Resolved: 0</span>';
        return;
      }

      snapshot.forEach(doc => {
        total++;
        const data = doc.data();
        const msg = data.message || '';
        const status = data.status || 'new';
        if (status === 'resolved') resolvedCount++; else newCount++;

        const ts = data.createdAt && data.createdAt.toDate
          ? data.createdAt.toDate()
          : null;

        const timeStr = ts ? ts.toLocaleString() : 'No timestamp';

        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div class="item-message">${msg.replace(/</g, '&lt;')}</div>
          <div class="item-meta-row">
            <div class="item-meta">
              <span>ID: ${doc.id}</span>
              <span>${timeStr}</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="status-badge status-${status}">${status === 'resolved' ? 'Resolved' : 'New'}</span>
              <button
                class="status-toggle-btn"
                data-id="${doc.id}"
                data-status="${status}"
              >
                ${status === 'resolved' ? 'Mark as new' : 'Mark as resolved'}
              </button>
            </div>
          </div>
        `;
        feedbackList.appendChild(item);
      });

      statsBar.innerHTML = `
        <span>Total: ${total}</span>
        <span>New: ${newCount}</span>
        <span>Resolved: ${resolvedCount}</span>
      `;

      // Attach click handlers for status buttons
      feedbackList.querySelectorAll('.status-toggle-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const current = btn.getAttribute('data-status');
          const next = current === 'resolved' ? 'new' : 'resolved';
          btn.disabled = true;
          btn.textContent = 'Updating...';
          try {
            await db.collection('feedback').doc(id).update({
              status: next
            });
          } catch (err) {
            console.error('Error updating status:', err);
            alert('Failed to update status. Check console.');
          } finally {
            // Firestore snapshot will re-render; no need to manually reset text
          }
        });
      });
    }

    // Auth state: if logged in -> show dashboard
    auth.onAuthStateChanged(user => {
      console.log('Auth state changed:', user && user.email);
      if (user) {
        loginSection.style.display = 'none';
        adminSection.style.display = 'block';
        adminEmailEl.textContent = user.email || '';

        unsubscribe && unsubscribe();
        unsubscribe = db.collection('feedback')
          .orderBy('createdAt', 'desc')
          .onSnapshot(renderFeedback, err => {
            console.error('Firestore error:', err);
            feedbackList.innerHTML = '<div class="item"><div class="item-message">Error loading feedback.</div></div>';
            statsBar.innerHTML = '<span>Total: 0</span><span>New: 0</span><span>Resolved: 0</span>';
          });

      } else {
        adminSection.style.display = 'none';
        loginSection.style.display = 'block';
        adminEmailEl.textContent = '';
        feedbackList.innerHTML = '';
        statsBar.innerHTML = '<span>Total: 0</span><span>New: 0</span><span>Resolved: 0</span>';
        unsubscribe && unsubscribe();
      }
    });

    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      loginError.textContent = '';
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        console.error(err);
        loginError.textContent = 'Login failed. Check email or password.';
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await auth.signOut();
    });
  </script>
</body>
</html>
